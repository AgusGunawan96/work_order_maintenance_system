<!-- wo_maintenance_app/templates/wo_maintenance_app/monitoring_informasi_system.html -->
<!-- FULLSCREEN STANDALONE - Tanpa Sidebar/Header dengan Fixed History ID -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title|default:"MONITORING INFORMASI SYSTEM" }}</title>
    
    <!-- jQuery CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <style>
        /* Reset dan Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .fullscreen-container {
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Header Style */
        .monitoring-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .header-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .stats-panel {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            backdrop-filter: blur(10px);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            display: block;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .last-update {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Database Indicator */
        .database-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 9999;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }
        
        /* Table Container */
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        /* Table Styles */
        .monitoring-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .monitoring-table th {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: 700;
            padding: 18px 15px;
            text-align: center;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 100;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid #2c3e50;
        }
        
        .monitoring-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #ecf0f1;
            text-align: center;
            font-size: 13px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }
        
        .monitoring-table tr:hover {
            background: rgba(52, 152, 219, 0.08);
            transform: scale(1.002);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Priority Badge */
        .prioritas-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .prioritas-high { background: #ff6b6b; color: white; }
        .prioritas-medium { background: #feca57; color: white; }
        .prioritas-low { background: #48dbfb; color: white; }
        
        .deskripsi-cell {
            text-align: left;
            padding: 15px 18px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.5;
            max-width: 250px;
        }
        
        /* Checker Button */
        .btn-cek {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            margin: 3px;
            cursor: pointer;
            border-radius: 20px;
            display: inline-block;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .btn-cek:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }
        
        .btn-cek:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Checker Display */
        .checker-display {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 11px;
            font-weight: bold;
            margin: 3px;
            display: inline-block;
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.4);
            animation: checkerAppear 0.5s ease;
        }
        
        @keyframes checkerAppear {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .checker-display.from-pengajuan {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: 2px solid #ff4757;
        }
        
        .checker-display.from-diproses {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: 2px solid #28a745;
        }
        
        .checker-time {
            font-size: 9px;
            opacity: 0.9;
            display: block;
            margin-top: 3px;
            font-weight: 500;
        }
        
        /* Row States */
        .row-checked-pengajuan {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important;
            border-left: 4px solid #ff6b6b;
        }
        
        .row-checked-diproses {
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important;
            border-left: 4px solid #28a745;
        }
        
        /* Status Colors */
        .status-pengajuan {
            background: linear-gradient(135deg, #DC143C 0%, #B91828 100%) !important;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .status-diproses {
            background: linear-gradient(135deg, #7FFF00 0%, #32CD32 100%) !important;
            color: #2c3e50 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .status-cell-database {
            min-height: 70px;
            vertical-align: middle;
            padding: 12px 8px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.5s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #7f8c8d;
        }
        
        .empty-state h4 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #5a6c7d;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .fullscreen-container { padding: 10px; }
            .header-title { font-size: 22px; }
            .stats-panel { grid-template-columns: 1fr 1fr; }
            .monitoring-table th, .monitoring-table td { padding: 8px 4px; font-size: 11px; }
            .database-indicator { position: relative; top: auto; right: auto; margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <div class="fullscreen-container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div>
                <div class="loading-spinner"></div>
                <div class="loading-text">Menyimpan ke Database...</div>
            </div>
        </div>

        <!-- Database indicator -->
        <div class="database-indicator" id="databaseIndicator">
            Database System: AKTIF (Loading...)
        </div>

        <!-- Header -->
        <div class="monitoring-header">
            <div class="header-title">
                <div class="header-icon">💻</div>
                <span>MONITORING INFORMASI SYSTEM - Fullscreen</span>
            </div>
            
            <div class="stats-panel">
                <div class="stat-item">
                    <div class="stat-number" id="totalPengajuan">{{ stats.total_pengajuan|default:0 }}</div>
                    <div class="stat-label">Pengajuan</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalDiproses">{{ stats.total_diproses|default:0 }}</div>
                    <div class="stat-label">Diproses</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalAll">{{ stats.total_all|default:0 }}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalChecked">{{ stats.total_checked|default:0 }}</div>
                    <div class="stat-label">Dicek</div>
                </div>
            </div>
            <div class="last-update" id="lastUpdate">
                Auto-refresh setiap 30 detik | Last update: {{ current_time|date:"d/m/Y H:i:s" }}
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table class="monitoring-table" id="monitoringTable">
                <thead>
                    <tr>
                        <th style="width: 8%;">PRIORITAS</th>
                        <th style="width: 12%;">WAKTU PENGAJUAN</th>
                        <th style="width: 12%;">NO PENGAJUAN</th>
                        <th style="width: 10%;">NOMOR WO</th>
                        <th style="width: 8%;">LINE</th>
                        <th style="width: 12%;">MESIN</th>
                        <th style="width: 25%;">DESKRIPSI</th>
                        <th style="width: 8%;">SECTION</th>
                        <th style="width: 5%;">STATUS</th>
                    </tr>
                </thead>
                <tbody id="monitoringTableBody">
                    {% if monitoring_data %}
                        {% for item in monitoring_data %}
                        <tr id="row-{{ item.no_pengajuan }}" data-database-row="true" 
                            {% if item.has_checker %}class="{% if item.checker_status_type == 'pengajuan' %}row-checked-pengajuan{% else %}row-checked-diproses{% endif %}"{% endif %}>
                            <td>
                                {% if item.prioritas != '-' %}
                                    <span class="prioritas-badge {% if item.prioritas == 'H' %}prioritas-high{% elif item.prioritas == 'M' %}prioritas-medium{% else %}prioritas-low{% endif %}">
                                        {{ item.prioritas }}
                                    </span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ item.waktu_pengajuan|default:"-" }}</td>
                            <td>{{ item.no_pengajuan }}</td>
                            <td>{{ item.nomor_wo }}</td>
                            <td>{{ item.line_name }}</td>
                            <td>{{ item.mesin_name }}</td>
                            <td class="deskripsi-cell">{{ item.deskripsi }}</td>
                            <td>{{ item.section_name }}</td>
                            <td class="status-cell-database {% if item.status == 'pengajuan' %}status-pengajuan{% else %}status-diproses{% endif %}">
                                {{ item.status|upper }}
                                <br><br>
                                <!-- FIXED: Checker System dengan history_id asli -->
                                <div class="database-checker-container" 
                                     data-row-id="row-{{ item.no_pengajuan }}" 
                                     data-history-id="{{ item.no_pengajuan }}" 
                                     data-status-type="{{ item.status }}">
                                    {% if item.has_checker %}
                                        <div class="checker-display {% if item.checker_status_type == 'pengajuan' %}from-pengajuan{% else %}from-diproses{% endif %}">
                                            ✅ {{ item.checker_name }}
                                            {% if item.checker_time %}
                                                <span class="checker-time">{{ item.checker_time|date:"d/m H:i" }}</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <button class="btn-cek" 
                                                data-id="{{ item.no_pengajuan }}" 
                                                data-history-id="{{ item.no_pengajuan }}" 
                                                title="Klik untuk cek item ini">
                                            Cek
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="empty-state">
                                <h4>Tidak Ada Data</h4>
                                <p>Belum ada data monitoring untuk ditampilkan saat ini.</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        console.log("=== FIXED FULLSCREEN MONITORING SYSTEM LOADED ===");

        var isUpdating = false;
        var isProcessingClick = false;
        var autoRefreshInterval;
        var keepAliveInterval;

        // =============== FIXED BUTTON CLICK HANDLER ===============
        
        $(document).on('click', '.btn-cek', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (isProcessingClick) return;
            isProcessingClick = true;
            
            var $button = $(this);
            var $row = $button.closest('tr');
            var rowId = $row.attr('id');
            var historyId = $button.attr('data-history-id');
            var $container = $button.closest('.database-checker-container');
            var statusType = $container.attr('data-status-type');
            
            console.log("=== FIXED BUTTON CLICK ===");
            console.log("Row ID:", rowId);
            console.log("History ID (EXACT):", historyId);
            console.log("Status Type:", statusType);
            
            // INPUT NAMA USER
            var userName = prompt("Siapa yang ngecek? Masukin nama asli:");
            
            if (!userName || userName.trim() === '') {
                isProcessingClick = false;
                return;
            }
            
            userName = userName.trim();
            
            // Validasi nama
            if (userName.toLowerCase() === 'test' || userName.toLowerCase() === 'testing') {
                showNotification('Jangan pake nama testing, pake nama asli!', 'error');
                isProcessingClick = false;
                return;
            }
            
            if (userName.length < 3) {
                showNotification('Nama minimal 3 karakter!', 'error');
                isProcessingClick = false;
                return;
            }
            
            console.log("Input valid - History:", historyId, "User:", userName, "Status:", statusType);
            
            // FIXED: SAVE TO DATABASE dengan history_id asli
            saveCheckerToDatabase(historyId, userName, statusType, function(success, response) {
                if (success) {
                    console.log("Database save success:", response);
                    
                    // Update UI immediately
                    updateRowUIFromDatabase($row, userName, statusType, new Date());
                    updateCheckedStatsFromDatabase();
                    
                    showNotification(response.message || `Berhasil dicek oleh: ${userName}`, 'success');
                    
                    // Refresh setelah 1 detik
                    setTimeout(function() {
                        if (!isUpdating) {
                            refreshDataFromDatabase();
                        }
                    }, 1000);
                    
                } else {
                    console.log("Database save failed:", response);
                    showNotification(response.error || 'Gagal menyimpan ke database', 'error');
                }
                
                isProcessingClick = false;
            });
        });

        // =============== FIXED DATABASE FUNCTIONS ===============
        
        function saveCheckerToDatabase(historyId, checkerName, statusType, callback) {
            console.log("Saving to database:", historyId, checkerName, statusType);
            
            showLoadingOverlay(true);
            
            var requestData = {
                history_id: historyId,  // FIXED: Pake history_id asli tanpa format tambahan
                checker_name: checkerName,
                status_type: statusType,
                device_id: navigator.userAgent.substring(0, 50),
                checker_notes: `FIXED: Status: ${statusType}`
            };
            
            $.ajax({
                url: '/wo-maintenance/database/save-checker/',  // FIXED: URL sesuai routing
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify(requestData),
                timeout: 30000,
                success: function(data) {
                    showLoadingOverlay(false);
                    console.log("Database save response:", data);
                    callback(data.success, data);
                },
                error: function(xhr, status, error) {
                    showLoadingOverlay(false);
                    console.error("Database save error:", error);
                    var errorMsg = 'Network error: ' + error;
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    callback(false, { error: errorMsg });
                }
            });
        }

        function refreshDataFromDatabase() {
            if (isUpdating) return;
            isUpdating = true;
            
            console.log("Starting refresh...");
            
            $.ajax({
                url: '/wo-maintenance/ajax/monitoring/refresh-database/',  // FIXED: URL sesuai routing  
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify({}),
                timeout: 25000,
                success: function(data) {
                    if (data.success) {
                        console.log("Refresh success");
                        updateTableFromDatabase(data.data);
                        updateStatsFromDatabase(data.stats);
                        updateLastUpdateTime(data.stats.last_update);
                    } else {
                        console.warn("Refresh failed:", data.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.warn('Refresh error:', error);
                },
                complete: function() {
                    isUpdating = false;
                }
            });
        }

        function updateTableFromDatabase(data) {
            var $tbody = $('#monitoringTableBody');
            $tbody.empty();
            
            console.log("Updating table with", data.length, "rows");
            
            if (data.length === 0) {
                $tbody.append('<tr><td colspan="9" class="empty-state"><h4>Tidak Ada Data</h4></td></tr>');
                return;
            }
            
            $.each(data, function(index, item) {
                var rowId = `row-${item.no_pengajuan}`;
                var statusColor = item.status === 'pengajuan' ? 'status-pengajuan' : 'status-diproses';
                
                var rowClass = '';
                if (item.has_checker) {
                    rowClass = item.checker_status_type === 'pengajuan' ? 'row-checked-pengajuan' : 'row-checked-diproses';
                }
                
                var checkerContent = '';
                if (item.has_checker && item.checker_name) {
                    var checkerClass = item.checker_status_type === 'pengajuan' ? 'from-pengajuan' : 'from-diproses';
                    var checkerTime = '';
                    if (item.checker_time) {
                        var timeObj = new Date(item.checker_time);
                        checkerTime = `<span class="checker-time">${timeObj.toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit'})} ${timeObj.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</span>`;
                    }
                    checkerContent = `<div class="checker-display ${checkerClass}">✅ ${item.checker_name}${checkerTime}</div>`;
                } else {
                    checkerContent = `<button class="btn-cek" data-id="${item.no_pengajuan}" data-history-id="${item.no_pengajuan}" title="Klik untuk cek">Cek</button>`;
                }
                
                var priorityHtml = item.prioritas !== '-' ? 
                    `<span class="prioritas-badge ${getPriorityClass(item.prioritas)}">${item.prioritas}</span>` : '-';
                
                var rowHtml = `
                    <tr id="${rowId}" ${rowClass ? `class="${rowClass}"` : ''}>
                        <td>${priorityHtml}</td>
                        <td>${item.waktu_pengajuan}</td>
                        <td>${item.no_pengajuan}</td>
                        <td>${item.nomor_wo}</td>
                        <td>${item.line_name}</td>
                        <td>${item.mesin_name}</td>
                        <td class="deskripsi-cell">${item.deskripsi}</td>
                        <td>${item.section_name}</td>
                        <td class="status-cell-database ${statusColor}">
                            ${item.status.toUpperCase()}
                            <br><br>
                            <div class="database-checker-container" data-row-id="${rowId}" data-history-id="${item.no_pengajuan}" data-status-type="${item.status}">
                                ${checkerContent}
                            </div>
                        </td>
                    </tr>
                `;
                
                $tbody.append(rowHtml);
            });
        }

        function updateRowUIFromDatabase($row, checkerName, statusType, checkerTime) {
            var $container = $row.find('.database-checker-container');
            if (!$container.length) return;
            
            $container.find('.btn-cek').remove();
            $container.find('.checker-display').remove();
            
            var cssClass = statusType === 'pengajuan' ? 'from-pengajuan' : 'from-diproses';
            var timeStr = '';
            if (checkerTime) {
                var timeObj = new Date(checkerTime);
                timeStr = `<span class="checker-time">${timeObj.toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit'})} ${timeObj.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</span>`;
            }
            
            var checkerHtml = `<div class="checker-display ${cssClass}">✅ ${checkerName}${timeStr}</div>`;
            $container.append(checkerHtml);
            
            $row.removeClass('row-checked-pengajuan row-checked-diproses');
            var rowClass = statusType === 'pengajuan' ? 'row-checked-pengajuan' : 'row-checked-diproses';
            $row.addClass(rowClass);
        }

        // =============== UTILITY FUNCTIONS ===============
        
        function updateStatsFromDatabase(stats) {
            $('#totalPengajuan').text(stats.total_pengajuan || 0);
            $('#totalDiproses').text(stats.total_diproses || 0);
            $('#totalAll').text(stats.total_all || 0);
            $('#totalChecked').text(stats.total_checked || 0);
        }

        function updateCheckedStatsFromDatabase() {
            var checkedCount = $('.checker-display').length;
            $('#totalChecked').text(checkedCount);
        }

        function updateLastUpdateTime(lastUpdate) {
            $('#lastUpdate').text(`Auto-refresh setiap 30 detik | Last update: ${lastUpdate}`);
        }
        
        function keepSessionAlive() {
            $.ajax({
                url: '/wo-maintenance/ajax/keep-session-alive/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify({})
            }).fail(function() {
                console.warn('Keep alive warning');
            });
        }
        
        function getPriorityClass(priority) {
            if (priority === 'H') return 'prioritas-high';
            if (priority === 'M') return 'prioritas-medium';
            return 'prioritas-low';
        }
        
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function showLoadingOverlay(show) {
            $('#loadingOverlay').css('display', show ? 'flex' : 'none');
        }

        function showNotification(message, type) {
            var $notification = $(`<div class="notification ${type}">${message}</div>`);
            $('body').append($notification);
            
            setTimeout(function() {
                $notification.css('animation', 'slideIn 0.5s ease reverse');
                setTimeout(function() {
                    $notification.remove();
                }, 500);
            }, 4000);
        }

        // =============== INITIALIZATION ===============
        
        setTimeout(function() {
            updateCheckedStatsFromDatabase();
            console.log("Initialization completed");
        }, 500);
        
        // Auto refresh setiap 30 detik
        autoRefreshInterval = setInterval(refreshDataFromDatabase, 30000);
        
        // Keep alive setiap 5 menit
        keepAliveInterval = setInterval(keepSessionAlive, 300000);
        
        // Update indicator
        setInterval(function() {
            var checkedCount = $('.checker-display').length;
            $('#databaseIndicator').html('Database System: AKTIF (' + checkedCount + ' tersimpan)');
        }, 3000);
        
        console.log("MONITORING SYSTEM READY");
        console.log("Auto-refresh: 30 detik");
        console.log("Database: Real-time sync");
        
        // Cleanup
        $(window).on('beforeunload', function() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (keepAliveInterval) clearInterval(keepAliveInterval);
        });
    });
    </script>
</body>
</html>
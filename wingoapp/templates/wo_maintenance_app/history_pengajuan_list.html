{% extends 'starter_kit/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block css %}
{{ block.super }}
<style>
    .page-body {
        padding-top: 20px;
    }
    
    /* Header Styles */
    .history-header {
        background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(111, 66, 193, 0.3);
    }
    
    .history-header h3 {
        margin: 0 0 10px 0;
        font-weight: 600;
    }
    
    .history-header .stats-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 15px;
    }
    
    .stat-item {
        background: rgba(255, 255, 255, 0.15);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    /* Filter Section */
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 5px solid #6f42c1;
    }
    
    .filter-title {
        color: #6f42c1;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* Table Styles */
    .table-section {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 5px solid #6f42c1;
    }
    
    .table-header {
        background: linear-gradient(135deg, #6f42c1, #007bff);
        color: white;
        padding: 20px 25px;
    }
    
    .table-title {
        font-weight: 600;
        font-size: 1.2rem;
        margin: 0;
    }
    
    .table th {
        background: #f8f9fa;
        color: #495057;
        font-weight: 600;
        border: none;
        padding: 15px 12px;
        font-size: 0.85rem;
        text-transform: uppercase;
    }
    
    .table td {
        padding: 12px;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Status Badges - UPDATED: Hanya untuk Status Pekerjaan */
    .status-badge {
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pekerjaan-open {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
    }
    
    .status-pekerjaan-close {
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        color: #0c5460;
    }
    
    /* Action Buttons - UPDATED: Hanya untuk Status Pekerjaan */
    .action-btn {
        margin: 2px;
        padding: 6px 12px;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 15px;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        width: 100%;
        margin-bottom: 4px;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .btn-pekerjaan-toggle-open {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .btn-pekerjaan-toggle-close {
        background: linear-gradient(135deg, #6c757d, #5a6268);
        color: white;
    }
    
    .btn-detail {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }
    
    /* Loading States */
    .btn-loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    /* Auto Status Notice */
    .auto-status-notice {
        background: linear-gradient(135deg, #e7f3ff 0%, #cce7ff 100%);
        border: 1px solid #b3d7ff;
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 20px;
        color: #0066cc;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* Pagination */
    .pagination-section {
        background: #f8f9fa;
        padding: 20px 25px;
        border-top: 1px solid #e9ecef;
    }
    
    .pagination .page-link {
        border-radius: 8px;
        margin: 0 2px;
        font-weight: 600;
        color: #6f42c1;
    }
    
    .pagination .page-link:hover {
        background-color: #6f42c1;
        border-color: #6f42c1;
        color: white;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #6f42c1;
        border-color: #6f42c1;
    }
    
    /* Alert Styles */
    .alert {
        border-radius: 8px;
        border: none;
        font-weight: 500;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .history-header {
            padding: 20px;
        }
        
        .table-responsive {
            font-size: 0.85rem;
        }
        
        .action-btn {
            padding: 4px 8px;
            font-size: 0.7rem;
        }
    }
</style>
{% endblock css %}

{% block content %}
<div class="page-body">
    {% include 'starter_kit/layout/breadcrumb.html' %}

    <!-- Header -->
    <div class="history-header">
        <h3>History Pengajuan Maintenance</h3>
        <p style="margin: 0; opacity: 0.9;">Kelola dan pantau status pengajuan maintenance yang telah diproses</p>
        
        <div class="stats-row">
            <div class="stat-item">
                <i class="fas fa-database"></i> Total: {{ stats.total_history }}
            </div>
            <div class="stat-item">
                <i class="fas fa-folder-open"></i> Work Open: {{ stats.pekerjaan_open_count }}
            </div>
            <div class="stat-item">
                <i class="fas fa-folder"></i> Work Close: {{ stats.pekerjaan_close_count }}
            </div>
            <div class="stat-item">
                <i class="fas fa-edit"></i> Edited Today: {{ stats.today_updates }}
            </div>
        </div>
    </div>

    <!-- Auto Status Notice -->
    <div class="auto-status-notice">
        <i class="fas fa-info-circle"></i>
        <div>
            <strong>Info:</strong> Status umum otomatis di-set ke "A" (Active). 
            Yang ditampilkan hanya status pekerjaan maintenance (Open/Close).
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Filter Section -->
    <div class="filter-section">
        <h6 class="filter-title">
            <i class="fas fa-filter"></i>
            Filter History
        </h6>
        
        <form method="get" id="filterForm">
            {% if search_query %}
                <input type="hidden" name="search" value="{{ search_query }}">
            {% endif %}
            
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Tanggal Dari</label>
                    {{ filter_form.tanggal_dari|add_class:"form-control" }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tanggal Sampai</label>
                    {{ filter_form.tanggal_sampai|add_class:"form-control" }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status Pekerjaan</label>
                    {{ filter_form.status_pekerjaan|add_class:"form-control" }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Section</label>
                    {{ filter_form.section_filter|add_class:"form-control" }}
                </div>
            </div>
            
            <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <label class="form-label">History ID</label>
                    {{ filter_form.history_id|add_class:"form-control" }}
                </div>
                <div class="col-md-2">
                    <label class="form-label">Pengaju</label>
                    {{ filter_form.pengaju|add_class:"form-control" }}
                </div>
                <div class="col-md-2">
                    <label class="form-label">PIC Produksi</label>
                    {{ filter_form.pic_produksi|add_class:"form-control" }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" 
                               value="{{ search_query }}" 
                               placeholder="Cari history ID, deskripsi...">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <a href="{% url 'wo_maintenance_app:history_pengajuan_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-refresh"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Table Section -->
    <div class="table-section">
        <div class="table-header">
            <h5 class="table-title">History Pengajuan</h5>
            <small>Total {{ total_records }} records ditemukan (Status umum auto-set ke A)</small>
        </div>
        
        {% if history_list %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 120px;">History ID</th>
                        <th style="width: 150px;">Pengaju</th>
                        <th style="width: 180px;">Mesin</th>
                        <th style="width: 120px;">Section</th>
                        <th>Deskripsi</th>
                        <th style="width: 120px;">Status Pekerjaan</th>
                        <th style="width: 150px;">PIC</th>
                        <th style="width: 120px;">Tanggal</th>
                        <th style="width: 140px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for history in history_list %}
                    <tr>
                        <td>
                            <strong class="text-primary">{{ history.0|default:"-" }}</strong>
                            {% if history.16 %}
                                <br><small class="text-muted">{{ history.16 }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-weight: 600;">{{ history.1|default:"-" }}</div>
                            {% if history.17 %}
                                <small class="text-muted">Edit: {{ history.17 }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div style="max-width: 160px; overflow: hidden; text-overflow: ellipsis;">
                                {{ history.2|default:"-" }}
                            </div>
                            {% if history.9 != 'N/A' %}
                                <br><small class="text-info">{{ history.9 }}</small>
                            {% endif %}
                        </td>
                        <td>{{ history.3|default:"-" }}</td>
                        <td>
                            <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                {{ history.4|default:"-"|truncatechars:60 }}
                            </div>
                        </td>
                        <td>
                            <!-- UPDATED: Hanya Status Pekerjaan yang ditampilkan -->
                            <span class="status-badge {% if history.5 == 'O' %}status-pekerjaan-open{% else %}status-pekerjaan-close{% endif %}" 
                                  id="status-pekerjaan-badge-{{ history.0 }}">
                                {% if history.5 == 'O' %}Open{% else %}Close{% endif %}
                            </span>
                            <br><small class="text-muted">Status Umum: Auto A</small>
                        </td>
                        <td>
                            <div style="font-size: 0.8rem;">
                                <div><strong>Prod:</strong> {{ history.6|default:"-"|truncatechars:20 }}</div>
                                <div><strong>Maint:</strong> {{ history.7|default:"-"|truncatechars:20 }}</div>
                            </div>
                        </td>
                        <td>
                            {% if history.8 %}
                                <div style="font-weight: 600;">{{ history.8|date:"d/m/Y" }}</div>
                                <small class="text-muted">{{ history.8|date:"H:i" }}</small>
                            {% else %}
                                -
                            {% endif %}
                            {% if history.16 %}
                                <br><small class="text-success">Edit: {{ history.16|date:"d/m H:i" }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group-vertical" role="group" style="width: 100%;">
                                <!-- UPDATED: Hanya Button untuk Status Pekerjaan -->
                                <button type="button" 
                                        class="action-btn {% if history.5 == 'O' %}btn-pekerjaan-toggle-close{% else %}btn-pekerjaan-toggle-open{% endif %}" 
                                        onclick="toggleStatusPekerjaan('{{ history.0 }}', '{% if history.5 == 'O' %}C{% else %}O{% endif %}')"
                                        id="status-pekerjaan-btn-{{ history.0 }}"
                                        title="{% if history.5 == 'O' %}Set Work to Close{% else %}Set Work to Open{% endif %}">
                                    <i class="fas fa-{% if history.5 == 'O' %}stop{% else %}play{% endif %}"></i>
                                    {% if history.5 == 'O' %}Close Work{% else %}Open Work{% endif %}
                                </button>
                                
                                <!-- Button Detail -->
                                <a href="{% url 'wo_maintenance_app:history_pengajuan_detail' history.0 %}" 
                                   class="action-btn btn-detail" title="View Detail">
                                    <i class="fas fa-eye"></i> Detail
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="pagination-section">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    Halaman {{ page_number }} dari {{ total_pages }} 
                    ({{ total_records }} total records)
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% for field in filter_form %}{% if field.value %}{% if field.name != 'search' %}&{{ field.name }}={{ field.value }}{% endif %}{% endif %}{% endfor %}">
                                    Previous
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in "12345"|make_list %}
                            {% if page_num|add:0 <= total_pages %}
                                {% if page_num|add:0 == page_number %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% for field in filter_form %}{% if field.value %}{% if field.name != 'search' %}&{{ field.name }}={{ field.value }}{% endif %}{% endif %}{% endfor %}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% for field in filter_form %}{% if field.value %}{% if field.name != 'search' %}&{{ field.name }}={{ field.value }}{% endif %}{% endif %}{% endfor %}">
                                    Next
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="text-center p-5">
            <i class="fas fa-search" style="font-size: 48px; color: #6c757d; margin-bottom: 20px;"></i>
            <h5>Tidak Ada Data History</h5>
            <p class="text-muted">
                {% if search_query %}
                    Tidak ditemukan history untuk pencarian "{{ search_query }}"
                {% else %}
                    Belum ada data history pengajuan maintenance
                {% endif %}
            </p>
            <a href="{% url 'wo_maintenance_app:daftar_laporan' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Lihat Pengajuan
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock content %}

{% block scriptcontent %}
{{ block.super }}
<script>
// UPDATED: Toggle hanya untuk status pekerjaan, status umum otomatis A
function toggleStatusPekerjaan(historyId, newStatus) {
    const statusText = newStatus === 'O' ? 'Open' : 'Close';
    
    if (!confirm(`Yakin ingin mengubah Status Pekerjaan ke ${statusText}?`)) {
        return;
    }
    
    // Show loading
    const button = document.getElementById(`status-pekerjaan-btn-${historyId}`);
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    button.disabled = true;
    button.classList.add('btn-loading');
    
    // AJAX call - UPDATED: Hanya untuk status_pekerjaan
    fetch('{% url "wo_maintenance_app:ajax_quick_update_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            history_id: historyId,
            status: newStatus,
            field_type: 'status_pekerjaan'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update badge
            const badge = document.getElementById(`status-pekerjaan-badge-${historyId}`);
            if (badge) {
                badge.textContent = data.status_display;
                badge.className = `status-badge ${data.new_status === 'O' ? 'status-pekerjaan-open' : 'status-pekerjaan-close'}`;
            }
            
            // Update button
            const oppositeText = data.opposite_status === 'O' ? 'Open' : 'Close';
            const oppositeIcon = data.opposite_status === 'O' ? 'play' : 'stop';
            const oppositeClass = data.opposite_status === 'O' ? 'btn-pekerjaan-toggle-open' : 'btn-pekerjaan-toggle-close';
            
            button.innerHTML = `<i class="fas fa-${oppositeIcon}"></i> ${oppositeText} Work`;
            button.className = `action-btn ${oppositeClass}`;
            
            // Update onclick
            button.onclick = () => toggleStatusPekerjaan(historyId, data.opposite_status);
            button.title = `Set Work to ${oppositeText}`;
            
            // Show success message
            showAlert('success', data.message + ' (Status umum tetap A)');
        } else {
            button.innerHTML = originalHTML;
            showAlert('error', data.error || 'Gagal update status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalHTML;
        showAlert('error', 'Terjadi kesalahan jaringan');
    })
    .finally(() => {
        button.disabled = false;
        button.classList.remove('btn-loading');
    });
}

function showAlert(type, message) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => {
        if (!alert.classList.contains('show')) {
            alert.remove();
        }
    });
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of page
    const container = document.querySelector('.page-body');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto dismiss after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        }
    }, 3000);
}

// Initialize page
$(document).ready(function() {
    // Auto submit filter on select change
    $('#filterForm select').on('change', function() {
        $('#filterForm').submit();
    });
    
    // Auto dismiss existing alerts
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
    
    console.log('History Pengajuan List loaded - STATUS UMUM REMOVED, AUTO-SET TO A');
    console.log('Only Status Pekerjaan controls available');
});
</script>
{% endblock scriptcontent %}
<!-- dailyactivity_app/templates/dailyactivity_app/laporan_index.html -->
{% extends 'starter_kit/base.html' %}
{% load static %}
{% load sass_tags %}
{% load widget_tweaks %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/prism.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/select2.scss' %}">
<!-- Plugins css Ends-->
<style>
  .page-body {
    padding-top: 20px;
  }
  .full-width-card {
    margin: 0 auto;
    padding: 0;
    width: 100%;
  }
  .card {
    margin-top: -20px;
    box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
  }
  .card-header h5 {
    margin-bottom: 0;
    font-size: 1.25rem;
  }
  .card-body {
    padding: 15px;
  }
  .form-inline-row .form-group {
    width: 18%;
    margin-right: 1%;
    display: inline-block;
    vertical-align: top;
  }
  .form-inline-row .form-group:last-child {
    margin-right: 0;
  }
  
  /* Style untuk section pekerjaan - WARNA HIJAU MINT */
  .pekerjaan-section {
    background: linear-gradient(135deg, #d4edd4 0%, #c8e6c9 100%) !important;
    border: 2px solid #4caf50;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 3px 6px rgba(76, 175, 80, 0.1);
  }
  
  .pekerjaan-row {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f5e8 100%) !important;
    border: 2px solid #a5d6a7;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.15);
    transition: all 0.3s ease;
  }
  
  .pekerjaan-row:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(76, 175, 80, 0.25);
    border-color: #4caf50;
    background: linear-gradient(135deg, #e3f2fd 0%, #c8e6c9 100%) !important;
  }
  
  .pekerjaan-row.new-row {
    background-color: #e8f5e8;
    border-color: #28a745;
    animation: fadeIn 0.5s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .delete-row-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10;
  }
  
  .delete-row-btn:hover {
    background: #c82333;
    transform: scale(1.1);
  }
  
  .add-pekerjaan-btn {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    margin-top: 20px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
  }
  
  .add-pekerjaan-btn:hover {
    background: linear-gradient(135deg, #218838, #1e7e34);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
  }
  
  .pekerjaan-header {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    margin: -25px -25px 25px -25px;
    font-weight: bold;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  }
  
  .pekerjaan-header::before {
    content: "üìã";
    margin-right: 10px;
    font-size: 1.3em;
  }
  
  .row-number {
    background: linear-gradient(135deg, #4caf50, #2e7d32);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    position: absolute;
    top: -15px;
    left: 20px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    z-index: 5;
  }
  
  /* Section groups untuk mengorganize fields */
  .field-group {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
  }
  
  .field-group-title {
    font-weight: 600;
    color: #2e7d32;
    font-size: 1.0em;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 8px;
  }
  
  .field-group-title.utility::before {
    content: "üåø";
    margin-right: 8px;
  }
  
  .field-group-title.maintenance::before {
    content: "üîß";
    margin-right: 8px;
  }
  
  .field-group-title.analysis::before {
    content: "‚ö†Ô∏è";
    margin-right: 8px;
  }
  
  /* Auto-fill indicator */
  .auto-filled {
    background-color: #e8f5e8 !important;
    border: 2px solid #4caf50 !important;
    animation: highlightAutoFill 2s ease-in-out;
  }
  
  @keyframes highlightAutoFill {
    0% { background-color: #c8e6c9; }
    50% { background-color: #a5d6a7; }
    100% { background-color: #e8f5e8; }
  }
  
  /* Style untuk catatan khusus */
  .catatan-section {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #f39c12;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
  }
  
  .catatan-header {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    margin: -20px -20px 15px -20px;
    font-weight: bold;
    display: flex;
    align-items: center;
  }
  
  .catatan-header::before {
    content: "üìù";
    margin-right: 10px;
    font-size: 1.2em;
  }
  
  .catatan-textarea {
    background-color: #fff3cd !important;
    color: #856404 !important;
    border: 2px solid #ffeaa7 !important;
    font-weight: 500 !important;
  }
  
  .catatan-textarea:focus {
    background-color: #fff3cd !important;
    color: #856404 !important;
    border-color: #f39c12 !important;
    box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25) !important;
  }
  
  /* Form field styling */
  .form-control {
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
  }
  
  .form-control:focus {
    border-color: #4caf50;
    box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
  }
  
  .field-label {
    font-weight: 600;
    color: #2e7d32;
    font-size: 0.85em;
    margin-bottom: 5px;
    display: block;
  }
  
  /* Responsive design */
  @media (max-width: 768px) {
    .pekerjaan-section {
      padding: 15px;
    }
    
    .pekerjaan-header {
      margin: -15px -15px 20px -15px;
      padding: 12px 18px;
    }
    
    .pekerjaan-row {
      padding: 20px;
    }
    
    .form-inline-row .form-group {
      width: 100%;
      margin-right: 0;
      margin-bottom: 15px;
    }
    
    .field-group {
      padding: 12px;
    }
  }
</style>
{% endblock css %}

{% block content %}
<div class="page-body">
  {% include 'starter_kit/layout/breadcrumb.html' %}
  
  <!-- Notifikasi untuk pesan -->
  {% if messages %}
      <div class="alert alert-success" role="alert">
          {% for message in messages %}
              {{ message }}<br>
          {% endfor %}
      </div>
  {% endif %}
  
  <!-- Card Full Width -->
  <div class="card full-width-card mt-4">
    <div class="card-header">
      <h5>Input Laporan Utility New - Enhanced</h5>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{% url 'dailyactivity_app:laporan_submit' %}">
            {% csrf_token %}
            
            <!-- Row for Tanggal, Shift, PIC (YANG UDAH ADA JANGAN DIHAPUS) -->
            <div class="form-inline-row">
                <div class="form-group">
                    <label for="tanggal">Tanggal:</label>
                    <input type="date" class="form-control" id="tanggal" name="tanggal" required>
                </div>            
                <div class="form-group">
                    <label for="shift">Shift:</label>
                    <select class="form-control select2" id="shift" name="shift" required>
                        <option value="">-- Pilih Shift --</option>
                        {% for shift in shifts %}
                            <option value="{{ shift.id }}">{{ shift.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label for="pic">PIC:</label>
                    <select class="form-control select2" id="pic" name="pic" required multiple>
                        {% for pic in pic_laporan %}
                            <option value="{{ pic.id }}">{{ pic.name }} ({{ pic.nokar }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                  <label for="piclembur">PIC Lembur:</label>
                  <select class="form-control select2" id="piclembur" name="piclembur" multiple>
                      {% for pic in pic_lembur %}
                          <option value="{{ pic.id }}">{{ pic.name }} ({{ pic.nokar }})</option>
                      {% endfor %}
                  </select>
              </div>             
            </div>
            
            <!-- Section untuk Laporan Utility Enhanced -->
            <div class="pekerjaan-section">
                <div class="pekerjaan-header">
                    Data Laporan Harian Utility
                </div>
                
                <div id="pekerjaan-container">
                    <!-- Baris pekerjaan pertama dengan semua field dalam 1 section -->
                    <div class="pekerjaan-row" data-row="1">
                        <div class="row-number">1</div>
                        <button type="button" class="delete-row-btn" onclick="removePekerjaanRow(this)" style="display: none;">
                            <i class="fa fa-times"></i>
                        </button>
                        
                        <!-- FIELD GROUP: Data Utility (JENIS PEKERJAAN DIHILANGKAN) -->
                        <div class="field-group">
                            <div class="field-group-title utility">Data Utility</div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label class="field-label">üìù Deskripsi Pekerjaan:</label>
                                    <textarea class="form-control deskripsi-input" name="deskripsi_pekerjaan[]" rows="2" placeholder="Deskripsi detail pekerjaan yang dilakukan..." required></textarea>
                                    <small class="text-muted">üí° Pilih Nomor WO untuk auto-fill deskripsi</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="field-label">üë§ PIC Pekerjaan:</label>
                                    <input type="text" class="form-control" name="pic_pekerjaan[]" placeholder="Nama PIC yang bertanggung jawab" required>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <label class="field-label">‚è±Ô∏è Lama Pekerjaan:</label>
                                    <input type="text" class="form-control" name="lama_pekerjaan[]" placeholder="Contoh: 2 jam, 30 menit, 1 hari, dll" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- FIELD GROUP: Data WO & Maintenance -->
                        <div class="field-group">
                            <div class="field-group-title maintenance">Data WO & Maintenance</div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="field-label">üìã Nomor WO:</label>
                                    <select class="form-control select2 nomor-wo-dropdown" name="nomor_wo[]" onchange="loadWODetails(this)">
                                        <option value="">-- Pilih Nomor WO --</option>
                                        {% for wo in nomor_wo_list %}
                                            <option value="{{ wo.value }}">{{ wo.text }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">üîÑ Auto-fill data saat dipilih</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="field-label">üîÑ Status:</label>
                                    <select class="form-control" name="status_utility[]">
                                        <option value="proses">Proses</option>
                                        <option value="selesai">Selesai</option>
                                        <option value="hold">Hold</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="field-label">üî® Jenis Pekerjaan Maintenance:</label>
                                    <select class="form-control select2 jenis-maintenance-dropdown" name="jenis_pekerjaan_maintenance[]">
                                        <option value="">-- Pilih Jenis Pekerjaan --</option>
                                        {% for pekerjaan in jenis_pekerjaan_list %}
                                            <option value="{{ pekerjaan.value }}">{{ pekerjaan.text }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <label class="field-label">üìç Lokasi:</label>
                                    <select class="form-control select2 lokasi-dropdown" name="lokasi[]" onchange="loadMesinByLokasiUtility(this)">
                                        <option value="">-- Pilih Lokasi --</option>
                                        {% for lokasi in lokasi_list %}
                                            <option value="{{ lokasi.value }}">{{ lokasi.text }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="field-label">‚öôÔ∏è Mesin:</label>
                                    <select class="form-control select2 mesin-dropdown" name="mesin[]" onchange="loadNomorMesinUtility(this)">
                                        <option value="">-- Pilih Mesin --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="field-label">üî¢ Nomor Mesin:</label>
                                    <input type="text" class="form-control nomor-mesin-input" name="nomor_mesin[]" placeholder="Nomor mesin (otomatis/manual)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- FIELD GROUP: Analisis Masalah -->
                        <div class="field-group">
                            <div class="field-group-title analysis">Analisis Masalah & Perbaikan</div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="field-label">‚ùì Penyebab:</label>
                                    <textarea class="form-control penyebab-input" name="penyebab[]" rows="2" placeholder="Jelaskan penyebab masalah..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="field-label">üîß Tindakan Perbaikan:</label>
                                    <textarea class="form-control tindakan-input" name="tindakan_perbaikan[]" rows="2" placeholder="Jelaskan tindakan perbaikan yang dilakukan..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="add-pekerjaan-btn" onclick="addPekerjaanRow()">
                    <i class="fa fa-plus"></i> Tambah Data Laporan Baru
                </button>
                
                <div class="mt-3">
                    <small class="form-text text-muted">
                        <strong>üìã Catatan:</strong> Setiap baris akan disimpan sebagai record terpisah dengan data utility dan maintenance lengkap. 
                        Pilih Nomor WO untuk auto-fill data maintenance. Data WO & Maintenance bersifat opsional.
                    </small>
                </div>
            </div>
            
            <!-- Section untuk Catatan Khusus (YANG UDAH ADA JANGAN DIHAPUS) -->
            <div class="catatan-section">
                <div class="catatan-header">
                    Catatan Khusus
                </div>
                
                <div class="form-group">
                    <label class="field-label">Catatan Tambahan:</label>
                    <textarea class="form-control catatan-textarea" name="catatan" rows="3" placeholder="Masukkan catatan khusus atau informasi penting lainnya..."></textarea>
                    <small class="form-text text-muted">Catatan ini akan diterapkan untuk semua pekerjaan yang diinput</small>
                </div>
            </div>
            
            <!-- Row for Image (YANG UDAH ADA JANGAN DIHAPUS) -->
            <div class="form-row mt-3">                                
                <div class="form-group" style="width: 100%;">
                    <label for="image">Upload Image:</label>
                    <input type="file" class="form-control-file" id="image" name="image">
                    <small class="form-text text-muted">Upload gambar pendukung jika diperlukan (akan diterapkan ke pekerjaan pertama)</small>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fa fa-save"></i> Simpan Laporan Harian Utility
                </button>
                <a href="{% url 'dailyactivity_app:tanggal_laporan' %}" class="btn btn-secondary btn-lg ml-2">
                    <i class="fa fa-arrow-left"></i> Kembali
                </a>
            </div>
        </form>
    </div>
  </div>
</div>

<!-- Store dropdown data untuk JavaScript -->
{{ nomor_wo_list|json_script:"nomor-wo-data" }}
{{ lokasi_list|json_script:"lokasi-data" }}
{{ jenis_pekerjaan_list|json_script:"jenis-pekerjaan-data" }}
{% endblock content %}

{% block scriptcontent %}
<!-- Plugins JS start-->
<script src="{% static 'assets/js/prism/prism.min.js' %}"></script>
<script src="{% static 'assets/js/clipboard/clipboard.min.js' %}"></script>
<script src="{% static 'assets/js/custom-card/custom-card.js' %}"></script>
<script src="{% static 'assets/js/select2/select2.full.min.js' %}"></script>
<script src="{% static 'assets/js/select2/select2-custom.js' %}"></script> 

<script>
// Store dropdown data globally for new rows
const nomorWoData = JSON.parse(document.getElementById('nomor-wo-data').textContent);
const lokasiData = JSON.parse(document.getElementById('lokasi-data').textContent);
const jenisData = JSON.parse(document.getElementById('jenis-pekerjaan-data').textContent);

var dropdownData = {
    nomor_wo: nomorWoData,
    lokasi: lokasiData,
    jenis_pekerjaan: jenisData
};

$(document).ready(function() {
    $('.select2').select2({
        width: '100%',
        allowClear: true
    });
    
    // Set tanggal hari ini sebagai default
    document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
    
    updateRowNumbers();
});

// FUNGSI BARU: Auto-fill data berdasarkan nomor WO
function loadWODetails(woSelect) {
    var nomorWO = woSelect.value;
    var row = woSelect.closest('.pekerjaan-row');
    
    if (!nomorWO) {
        return;
    }
    
    // Show loading state
    var originalText = woSelect.options[woSelect.selectedIndex].text;
    woSelect.options[woSelect.selectedIndex].text = "üîÑ Loading...";
    
    fetch(`/dailyactivity/ajax/get-wo-details/?nomor_wo=${nomorWO}`)
        .then(response => response.json())
        .then(data => {
            // Restore original text
            woSelect.options[woSelect.selectedIndex].text = originalText;
            
            if (data.success) {
                // Auto-fill deskripsi pekerjaan
                var deskripsiInput = row.querySelector('.deskripsi-input');
                if (data.data.deskripsi_perbaikan) {
                    deskripsiInput.value = data.data.deskripsi_perbaikan;
                    deskripsiInput.classList.add('auto-filled');
                }
                
                // Auto-fill lokasi
                var lokasiSelect = row.querySelector('.lokasi-dropdown');
                if (data.data.id_line) {
                    lokasiSelect.value = data.data.id_line;
                    $(lokasiSelect).trigger('change');
                    lokasiSelect.classList.add('auto-filled');
                    
                    // Auto-fill mesin setelah lokasi di-set
                    setTimeout(() => {
                        loadMesinByLokasiUtility(lokasiSelect, data.data.id_mesin);
                    }, 500);
                }
                
                // Auto-fill penyebab
                var penyebabInput = row.querySelector('.penyebab-input');
                if (data.data.penyebab) {
                    penyebabInput.value = data.data.penyebab;
                    penyebabInput.classList.add('auto-filled');
                }
                
                // Auto-fill tindakan perbaikan
                var tindakanInput = row.querySelector('.tindakan-input');
                if (data.data.tindakan_perbaikan) {
                    tindakanInput.value = data.data.tindakan_perbaikan;
                    tindakanInput.classList.add('auto-filled');
                }
                
                // Show success message
                showNotification('‚úÖ Data WO berhasil dimuat dan auto-filled!', 'success');
                
                // Remove auto-filled classes after animation
                setTimeout(() => {
                    row.querySelectorAll('.auto-filled').forEach(el => {
                        el.classList.remove('auto-filled');
                    });
                }, 3000);
                
            } else {
                showNotification('‚ö†Ô∏è ' + (data.message || 'Data WO tidak ditemukan'), 'warning');
            }
        })
        .catch(error => {
            // Restore original text
            woSelect.options[woSelect.selectedIndex].text = originalText;
            console.error('Error loading WO details:', error);
            showNotification('‚ùå Error loading data WO', 'error');
        });
}

// FUNGSI FIXED: Load mesin berdasarkan lokasi (FOLLOW MECHANICAL PATTERN WITH DEBUG)
function loadMesinByLokasiUtility(lokasiSelect, targetMesinId = null) {
    var lokasiId = lokasiSelect.value;
    var row = lokasiSelect.closest('.pekerjaan-row');
    var mesinSelect = row.querySelector('.mesin-dropdown');
    var nomorMesinInput = row.querySelector('.nomor-mesin-input');
    
    console.log('DEBUG: loadMesinByLokasiUtility called with lokasiId:', lokasiId);
    
    // Reset dropdown mesin dan nomor mesin
    mesinSelect.innerHTML = '<option value="">-- Loading Mesin... --</option>';
    nomorMesinInput.value = '';
    
    if (lokasiId) {
        // Convert to integer to avoid float issues (28.0 -> 28)
        var lokasiIdInt = parseInt(parseFloat(lokasiId));
        var fetchUrl = `/dailyactivity/get_mesin_by_lokasi_utility/${lokasiIdInt}/`;
        
        console.log('DEBUG: Fetching URL:', fetchUrl);
        
        fetch(fetchUrl)
            .then(response => {
                console.log('DEBUG: Response status:', response.status);
                console.log('DEBUG: Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(machines => {
                console.log('DEBUG: Received machines data:', machines);
                
                // Clear loading option
                mesinSelect.innerHTML = '<option value="">-- Pilih Mesin --</option>';
                
                if (Array.isArray(machines) && machines.length > 0) {
                    // Add machines to dropdown (format sama seperti mechanical)
                    machines.forEach(function(machine) {
                        var displayName = machine.name;
                        if (machine.nomor) {
                            displayName += ` (${machine.nomor})`;
                        }
                        
                        var option = new Option(displayName, machine.id);
                        option.setAttribute('data-nomor', machine.nomor || '');
                        mesinSelect.add(option);
                    });
                    
                    // Auto-select mesin jika ada targetMesinId (dari WO)
                    if (targetMesinId) {
                        mesinSelect.value = targetMesinId;
                        mesinSelect.classList.add('auto-filled');
                        loadNomorMesinUtility(mesinSelect);
                    }
                    
                    // Reinitialize select2
                    $(mesinSelect).select2({
                        width: '100%',
                        allowClear: true
                    });
                    
                    showNotification(`‚úÖ Loaded ${machines.length} mesin untuk lokasi`, 'success');
                } else {
                    mesinSelect.innerHTML = '<option value="">-- Tidak ada mesin --</option>';
                    showNotification('‚ö†Ô∏è Tidak ada mesin untuk lokasi ini', 'warning');
                }
            })
            .catch(error => {
                console.error('ERROR: Loading mesin failed:', error);
                mesinSelect.innerHTML = '<option value="">-- Error Loading --</option>';
                
                // More specific error messages
                if (error.message.includes('404')) {
                    showNotification('‚ùå URL endpoint tidak ditemukan. Cek routing Django!', 'error');
                } else if (error.message.includes('JSON')) {
                    showNotification('‚ùå Response bukan JSON. Cek views.py!', 'error');
                } else {
                    showNotification(`‚ùå Error loading mesin: ${error.message}`, 'error');
                }
            });
    } else {
        // Reset ke default
        mesinSelect.innerHTML = '<option value="">-- Pilih Mesin --</option>';
        $(mesinSelect).select2({
            width: '100%',
            allowClear: true
        });
    }
}

// FUNGSI FIXED: Load nomor mesin berdasarkan mesin yang dipilih (WITH DEBUG)
function loadNomorMesinUtility(mesinSelect) {
    var machineId = mesinSelect.value;
    var row = mesinSelect.closest('.pekerjaan-row');
    var nomorMesinInput = row.querySelector('.nomor-mesin-input');
    
    console.log('DEBUG: loadNomorMesinUtility called with machineId:', machineId);
    
    if (!machineId) {
        nomorMesinInput.value = '';
        return;
    }
    
    // Try to get from data attribute first (faster)
    var selectedOption = mesinSelect.options[mesinSelect.selectedIndex];
    var nomorFromAttr = selectedOption.getAttribute('data-nomor') || '';
    
    console.log('DEBUG: nomorFromAttr:', nomorFromAttr);
    
    if (nomorFromAttr) {
        nomorMesinInput.value = nomorFromAttr;
        nomorMesinInput.classList.add('auto-filled');
        return;
    }
    
    // Fallback: fetch from server (follow mechanical pattern)
    var machineIdInt = parseInt(parseFloat(machineId));
    var fetchUrl = `/dailyactivity/get_machine_number_utility/${machineIdInt}/`;
    
    console.log('DEBUG: Fetching nomor mesin URL:', fetchUrl);
    
    fetch(fetchUrl)
        .then(response => {
            console.log('DEBUG: Nomor mesin response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('DEBUG: Nomor mesin data:', data);
            
            if (data.nomor) {
                nomorMesinInput.value = data.nomor;
                nomorMesinInput.classList.add('auto-filled');
            } else {
                nomorMesinInput.value = '';
            }
        })
        .catch(error => {
            console.error('ERROR: Loading nomor mesin failed:', error);
            nomorMesinInput.value = '';
            showNotification(`‚ùå Error loading nomor mesin: ${error.message}`, 'error');
        });
}

// UTILITY: Show notifications
function showNotification(message, type = 'info') {
    var alertClass = 'alert-info';
    if (type === 'success') alertClass = 'alert-success';
    if (type === 'warning') alertClass = 'alert-warning';
    if (type === 'error') alertClass = 'alert-danger';
    
    var notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        notification.fadeOut();
    }, 3000);
}

// FUNGSI ADD ROW (UPDATED TANPA JENIS PEKERJAAN)
let pekerjaanRowCount = 1;

function addPekerjaanRow() {
    pekerjaanRowCount++;
    
    const container = document.getElementById('pekerjaan-container');
    const newRow = document.createElement('div');
    newRow.className = 'pekerjaan-row new-row';
    newRow.setAttribute('data-row', pekerjaanRowCount);
    
    // Generate dropdown options
    let nomorWoOptions = '<option value="">-- Pilih Nomor WO --</option>';
    dropdownData.nomor_wo.forEach(wo => {
        nomorWoOptions += `<option value="${wo.value}">${wo.text}</option>`;
    });
    
    let lokasiOptions = '<option value="">-- Pilih Lokasi --</option>';
    dropdownData.lokasi.forEach(lokasi => {
        lokasiOptions += `<option value="${lokasi.value}">${lokasi.text}</option>`;
    });
    
    let jenisOptions = '<option value="">-- Pilih Jenis Pekerjaan --</option>';
    dropdownData.jenis_pekerjaan.forEach(jenis => {
        jenisOptions += `<option value="${jenis.value}">${jenis.text}</option>`;
    });
    
    newRow.innerHTML = `
        <div class="row-number">${pekerjaanRowCount}</div>
        <button type="button" class="delete-row-btn" onclick="removePekerjaanRow(this)">
            <i class="fa fa-times"></i>
        </button>
        
        <!-- FIELD GROUP: Data Utility (TANPA JENIS PEKERJAAN) -->
        <div class="field-group">
            <div class="field-group-title utility">Data Utility</div>
            <div class="row">
                <div class="col-md-8">
                    <label class="field-label">üìù Deskripsi Pekerjaan:</label>
                    <textarea class="form-control deskripsi-input" name="deskripsi_pekerjaan[]" rows="2" placeholder="Deskripsi detail pekerjaan yang dilakukan..." required></textarea>
                    <small class="text-muted">üí° Pilih Nomor WO untuk auto-fill deskripsi</small>
                </div>
                <div class="col-md-4">
                    <label class="field-label">üë§ PIC Pekerjaan:</label>
                    <input type="text" class="form-control" name="pic_pekerjaan[]" placeholder="Nama PIC yang bertanggung jawab" required>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="field-label">‚è±Ô∏è Lama Pekerjaan:</label>
                    <input type="text" class="form-control" name="lama_pekerjaan[]" placeholder="Contoh: 2 jam, 30 menit, 1 hari, dll" required>
                </div>
            </div>
        </div>
        
        <!-- FIELD GROUP: Data WO & Maintenance -->
        <div class="field-group">
            <div class="field-group-title maintenance">Data WO & Maintenance</div>
            <div class="row">
                <div class="col-md-4">
                    <label class="field-label">üìã Nomor WO:</label>
                    <select class="form-control select2 nomor-wo-dropdown" name="nomor_wo[]" onchange="loadWODetails(this)">
                        ${nomorWoOptions}
                    </select>
                    <small class="text-muted">üîÑ Auto-fill data saat dipilih</small>
                </div>
                <div class="col-md-4">
                    <label class="field-label">üîÑ Status:</label>
                    <select class="form-control" name="status_utility[]">
                        <option value="proses">Proses</option>
                        <option value="selesai">Selesai</option>
                        <option value="hold">Hold</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="field-label">üî® Jenis Pekerjaan Maintenance:</label>
                    <select class="form-control select2 jenis-maintenance-dropdown" name="jenis_pekerjaan_maintenance[]">
                        ${jenisOptions}
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-4">
                    <label class="field-label">üìç Lokasi:</label>
                    <select class="form-control select2 lokasi-dropdown" name="lokasi[]" onchange="loadMesinByLokasiUtility(this)">
                        ${lokasiOptions}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="field-label">‚öôÔ∏è Mesin:</label>
                    <select class="form-control select2 mesin-dropdown" name="mesin[]" onchange="loadNomorMesinUtility(this)">
                        <option value="">-- Pilih Mesin --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="field-label">üî¢ Nomor Mesin:</label>
                    <input type="text" class="form-control nomor-mesin-input" name="nomor_mesin[]" placeholder="Nomor mesin (otomatis/manual)">
                </div>
            </div>
        </div>
        
        <!-- FIELD GROUP: Analisis Masalah -->
        <div class="field-group">
            <div class="field-group-title analysis">Analisis Masalah & Perbaikan</div>
            <div class="row">
                <div class="col-md-6">
                    <label class="field-label">‚ùì Penyebab:</label>
                    <textarea class="form-control penyebab-input" name="penyebab[]" rows="2" placeholder="Jelaskan penyebab masalah..."></textarea>
                </div>
                <div class="col-md-6">
                    <label class="field-label">üîß Tindakan Perbaikan:</label>
                    <textarea class="form-control tindakan-input" name="tindakan_perbaikan[]" rows="2" placeholder="Jelaskan tindakan perbaikan yang dilakukan..."></textarea>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(newRow);
    updateDeleteButtons();
    updateRowNumbers();
    
    // Initialize select2 for new dropdowns
    $(newRow).find('.select2').select2({
        width: '100%',
        allowClear: true
    });
    
    // Animasi untuk row baru
    setTimeout(() => {
        newRow.classList.remove('new-row');
    }, 2000);
    
    // Scroll ke row baru
    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function removePekerjaanRow(button) {
    if (confirm('Apakah Anda yakin ingin menghapus baris pekerjaan ini?')) {
        const row = button.closest('.pekerjaan-row');
        row.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
            row.remove();
            updateDeleteButtons();
            updateRowNumbers();
        }, 300);
    }
}

function updateDeleteButtons() {
    const rows = document.querySelectorAll('.pekerjaan-row');
    rows.forEach((row, index) => {
        const deleteBtn = row.querySelector('.delete-row-btn');
        if (rows.length > 1) {
            deleteBtn.style.display = 'flex';
        } else {
            deleteBtn.style.display = 'none';
        }
    });
}

function updateRowNumbers() {
    const rows = document.querySelectorAll('.pekerjaan-row');
    rows.forEach((row, index) => {
        const rowNumber = row.querySelector('.row-number');
        rowNumber.textContent = index + 1;
        row.setAttribute('data-row', index + 1);
    });
}

// Validasi form sebelum submit
document.querySelector('form').addEventListener('submit', function(e) {
    const pekerjaanRows = document.querySelectorAll('.pekerjaan-row');
    if (pekerjaanRows.length === 0) {
        e.preventDefault();
        alert('Minimal harus ada satu pekerjaan!');
        return false;
    }
    
    // Validasi setiap baris pekerjaan
    let isValid = true;
    let emptyFields = [];
    
    pekerjaanRows.forEach((row, index) => {
        const inputs = row.querySelectorAll('input[required], textarea[required]');
        inputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.style.borderColor = '#dc3545';
                input.style.backgroundColor = '#fff5f5';
                emptyFields.push(`Baris ${index + 1}: ${input.placeholder}`);
            } else {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        });
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Harap lengkapi semua field yang wajib diisi:\n\n' + emptyFields.join('\n'));
        return false;
    }
    
    // Konfirmasi submit
    const rowCount = pekerjaanRows.length;
    if (!confirm(`Apakah Anda yakin ingin menyimpan ${rowCount} data laporan harian utility?`)) {
        e.preventDefault();
        return false;
    }
});

// Auto-hide success messages
setTimeout(function() {
    $('.alert-success').fadeOut('slow');
}, 5000);
</script>

<style>
@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
}
</style>
{% endblock scriptcontent %}
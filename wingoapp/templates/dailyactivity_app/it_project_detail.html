{% extends 'starter_kit/base.html' %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/prism.scss' %}">
<!-- Plugins css Ends-->
{% endblock css %}

{% block content %}
<div class="page-body">
  {% include 'starter_kit/layout/breadcrumb.html' %}
  <div class="container">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Detail IT Project Management</h3>
        <a href="{% url 'dailyactivity_app:export_excel' project.id %}" class="btn btn-success btn-sm">
          <i class="fa fa-download"></i> Export Excel
        </a>
      </div>    
      
      <div class="card-body">
        <!-- Informasi Project -->
        <div class="row mb-4">
          <div class="col-md-12">
            <h5 class="text-primary">Informasi Project</h5>
            <hr>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="font-weight-bold">Nama Project</label>
            <input type="text" class="form-control" value="{{ project.project_name }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="font-weight-bold">PIC Project</label>
            <input type="text" class="form-control" value="{{ project.pic_project }}" readonly>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="font-weight-bold">Department</label>
            <input type="text" class="form-control" value="{{ project.department }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="font-weight-bold">Waktu Pengerjaan</label>
            <input type="text" class="form-control" value="{{ project.waktu_pengerjaan|default:'Tidak ditentukan' }}" readonly>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="font-weight-bold">Start Date</label>
            <input type="date" class="form-control" value="{{ project.start_date|date:'Y-m-d' }}" readonly>
          </div>
          <div class="col-md-3">
            <label class="font-weight-bold">Finish Date</label>
            <input type="date" class="form-control" value="{{ project.finish_date|date:'Y-m-d' }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="font-weight-bold">Jenis Pekerjaan</label>
            <input type="text" class="form-control" value="{{ project.jenis_pekerjaan|default:'Tidak ditentukan' }}" readonly>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-4">
            <label class="font-weight-bold">Line</label>
            <input type="text" class="form-control" value="{{ project.line|default:'Tidak ditentukan' }}" readonly>
          </div>
          <div class="col-md-4">
            <label class="font-weight-bold">Mesin</label>
            <input type="text" class="form-control" value="{{ project.mesin|default:'Tidak ditentukan' }}" readonly>
          </div>
          <div class="col-md-4">
            <label class="font-weight-bold">Nomor Mesin</label>
            <input type="text" class="form-control" value="{{ project.nomor_mesin|default:'Tidak ditentukan' }}" readonly>
          </div>
        </div>

        <!-- Form untuk menambah issue baru -->
        <form method="POST" action="{% url 'dailyactivity_app:submit_issues' %}">
          {% csrf_token %}
          <input type="hidden" name="project_id" value="{{ project.id }}">
          
          <!-- Issues List -->
          <div class="row mb-3">
            <div class="col-md-12">
              <h5 class="text-primary">Issues List</h5>
              <hr>
            </div>
          </div>

          <!-- Existing Issues -->
          {% if issues %}
          <div class="table-responsive mb-4">
            <table class="table table-bordered table-striped">
              <thead class="thead-dark">
                <tr>
                  <th style="width: 5%">No</th>
                  <th style="width: 15%">Issue</th>
                  <th style="width: 12%">Tindakan</th>
                  <th style="width: 12%">Perbaikan</th>
                  <th style="width: 10%">PIC</th>
                  <th style="width: 10%">Due Date</th>
                  <th style="width: 8%">Status</th>
                  <th style="width: 13%">Remark</th>
                  <th style="width: 15%">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for issue in issues %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ issue.issue }}</td>
                  <td>{{ issue.tindakan|default:'Belum ada tindakan' }}</td>
                  <td>{{ issue.perbaikan|default:'Belum ada perbaikan' }}</td>
                  <td>{{ issue.pic }}</td>
                  <td>{{ issue.due_date|date:'d-m-Y' }}</td>
                  <td>
                    <span class="badge {% if issue.status == '100' %}badge-success{% elif issue.status >= '70' %}badge-warning{% else %}badge-secondary{% endif %}">
                      {{ issue.status }}%
                    </span>
                  </td>
                  <td>{{ issue.remark|default:'Tidak ada catatan' }}</td>
                  <td>
                    <a href="{% url 'dailyactivity_app:delete_issue' issue.id %}" 
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Yakin mau hapus issue ini bro?')">
                      <i class="fa fa-trash"></i> Delete
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          <!-- Form untuk tambah issue baru -->
          <div class="row mb-3">
            <div class="col-md-12">
              <h6 class="text-info">Tambah Issue Baru</h6>
              <hr>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered" id="issuesTable">
              <thead class="thead-light">
                <tr>
                  <th style="width: 5%">No</th>
                  <th style="width: 15%">Issue</th>
                  <th style="width: 12%">Tindakan</th>
                  <th style="width: 12%">Perbaikan</th>
                  <th style="width: 10%">PIC</th>
                  <th style="width: 10%">Due Date</th>
                  <th style="width: 8%">Status</th>
                  <th style="width: 13%">Remark</th>
                  <th style="width: 15%">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td><textarea class="form-control" name="issue_1" rows="2" placeholder="Deskripsikan issue baru..."></textarea></td>
                  <td><textarea class="form-control" name="issue_tindakan_1" rows="2" placeholder="Tindakan yang diambil..."></textarea></td>
                  <td><textarea class="form-control" name="issue_perbaikan_1" rows="2" placeholder="Cara perbaikan..."></textarea></td>
                  <td><input type="text" class="form-control" name="issue_pic_1" placeholder="Nama PIC"></td>
                  <td><input type="date" class="form-control" name="issue_due_1"></td>
                  <td>
                    <select class="form-control" name="issue_status_1">
                      <option value="0">0%</option>
                      <option value="10">10%</option>
                      <option value="20">20%</option>
                      <option value="30">30%</option>
                      <option value="40">40%</option>
                      <option value="50">50%</option>
                      <option value="60">60%</option>
                      <option value="70">70%</option>
                      <option value="80">80%</option>
                      <option value="90">90%</option>
                      <option value="100">100%</option>
                    </select>
                  </td>
                  <td><textarea class="form-control" name="issue_remark_1" rows="2" placeholder="Catatan tambahan..."></textarea></td>
                  <td><button type="button" class="btn btn-danger btn-sm remove-row">Hapus</button></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3">
            <button type="button" id="addRow" class="btn btn-primary mr-2">
              <i class="fa fa-plus"></i> Tambah Issue
            </button>
            <button type="submit" class="btn btn-success">
              <i class="fa fa-save"></i> Simpan Issues
            </button>
            <a href="{% url 'dailyactivity_app:it_tanggal_project' %}" class="btn btn-secondary">
              <i class="fa fa-arrow-left"></i> Kembali
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scriptcontent %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const table = document.getElementById('issuesTable').getElementsByTagName('tbody')[0];
    const addRowButton = document.getElementById('addRow');

    // Fungsi untuk memperbarui nomor urut dan nama elemen input
    function updateRowIndexes() {
        Array.from(table.rows).forEach((row, index) => {
            // Update nomor urut
            row.cells[0].textContent = index + 1;

            // Update nama atribut input dan select
            const inputs = row.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const nameParts = input.name.split('_');
                nameParts[nameParts.length - 1] = index + 1; // Perbarui indeks akhir
                input.name = nameParts.join('_');
            });
        });
    }

    // Menambahkan baris baru
    addRowButton.addEventListener('click', function () {
        const rowCount = table.rows.length + 1;
        const newRow = table.insertRow();

        // Tambahkan sel ke baris baru
        newRow.innerHTML = `
            <td>${rowCount}</td>
            <td><textarea class="form-control" name="issue_${rowCount}" rows="2" placeholder="Deskripsikan issue baru..." required></textarea></td>
            <td><textarea class="form-control" name="issue_tindakan_${rowCount}" rows="2" placeholder="Tindakan yang diambil..."></textarea></td>
            <td><textarea class="form-control" name="issue_perbaikan_${rowCount}" rows="2" placeholder="Cara perbaikan..."></textarea></td>
            <td><input type="text" class="form-control" name="issue_pic_${rowCount}" placeholder="Nama PIC" required></td>
            <td><input type="date" class="form-control" name="issue_due_${rowCount}" required></td>
            <td>
                <select class="form-control" name="issue_status_${rowCount}">
                    <option value="0">0%</option>
                    <option value="10">10%</option>
                    <option value="20">20%</option>
                    <option value="30">30%</option>
                    <option value="40">40%</option>
                    <option value="50">50%</option>
                    <option value="60">60%</option>
                    <option value="70">70%</option>
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
                </select>
            </td>
            <td><textarea class="form-control" name="issue_remark_${rowCount}" rows="2" placeholder="Catatan tambahan..." required></textarea></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Hapus</button></td>
        `;
    });

    // Menghapus baris
    table.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-row')) {
            if (table.rows.length > 1) {
                const row = e.target.closest('tr');
                row.remove(); // Hapus baris
                // Perbarui nomor urut dan nama elemen input setelah baris dihapus
                updateRowIndexes();
            } else {
                alert('Minimal harus ada 1 issue bro!');
            }
        }
    });
});
</script>
{% endblock scriptcontent %}
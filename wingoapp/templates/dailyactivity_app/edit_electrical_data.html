{% extends 'starter_kit/base.html' %}
{% load static %}
{% load sass_tags %}
{% load widget_tweaks %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/prism.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/select2.scss' %}">
<!-- Plugins css Ends-->
<style>
  .page-body {
    padding-top: 20px;
  }
  .full-width-card {
    margin: 0 auto;
    padding: 0;
    width: 100%;
  }
  .card {
    margin-top: -20px;
    box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
  }
  .card-header h5 {
    margin-bottom: 0;
    font-size: 1.25rem;
  }
  .card-body {
    padding: 15px;
  }
  .form-inline-row .form-group {
    width: 18%;
    margin-right: 1%;
    display: inline-block;
    vertical-align: top;
  }
  .form-inline-row .form-group:last-child {
    margin-right: 0;
  }
</style>
{% endblock css %}

{% block content %}
<div class="page-body">
  {% include 'starter_kit/layout/breadcrumb.html' %}

  {% if messages %}
      <div class="alert alert-success" role="alert">
          {% for message in messages %}
              {{ message }}<br>
          {% endfor %}
      </div>
  {% endif %}

  <div class="card full-width-card mt-4">
    <div class="card-header">
        <h5>Edit Electrical Activity</h5>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{% url 'dailyactivity_app:edit_electrical_data' data.id %}">

            {% csrf_token %}
            
            <div class="form-inline-row">
                <div class="form-group">
                    <label for="tanggal">Tanggal:</label>
                    <input type="date" class="form-control" id="tanggal" name="tanggal" value="{{ tanggal }}" required>
                </div>
                
                <div class="form-group col-md-2">
                    <label for="tgl_his">Waktu WO:</label>
                    <input type="datetime-local" class="form-control" id="tgl_his" name="tgl_his" value="{{ tgl_his|date:"Y-m-d\TH:i" }}" />
                </div>  
               
                <div class="form-group col-md-2">
                    <label for="nomor_wo">Nomor WO:</label>
                    <input type="text" class="form-control" id="nomor_wo" name="nomor_wo" value="{{ nomor_wo }}">
                </div>
                <div class="form-group col-md-2">
                    <label for="waktu_pengerjaan">Waktu Pengerjaan:</label>
                    <input type="text" class="form-control" id="waktu_pengerjaan" name="waktu_pengerjaan" value="{{ waktu_pengerjaan }}" required>
                </div>
                <div class="form-group">
                    <label for="shift">Shift:</label>
                    <select class="form-control select2" id="shift" name="shift" required>
                        <option value="">-- Pilih Shift --</option>
                        {% for shift in shifts %}
                            <option value="{{ shift.id }}" {% if data.shift_id == shift.id %}selected{% endif %}>{{ shift.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label for="location">Location:</label>
                    <select class="form-control select2" id="location" name="location" required>
                        <option value="">-- Pilih Lokasi --</option>
                        {% for loc in locations %}
                            <option value="{{ loc.id }}" {% if data.location_id == loc.id %}selected{% endif %}>{{ loc.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label for="machine">Machine:</label>
                    <select class="form-control select2" id="machine" name="machine" required>
                        <option value="">-- Pilih Mesin --</option>
                        {% for machine in machines %}
                            <option value="{{ machine.id }}" {% if data.machine_id == machine.id %}selected{% endif %}>{{ machine.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label for="category">Jenis Pekerjaan:</label>
                    <select class="form-control select2" id="category" name="category" required>
                        <option value="">-- Pilih Category --</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if data.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label for="status">Status:</label>
                    <select class="form-control select2" id="status" name="status" required>
                        <option value="">-- Pilih Status --</option>
                        {% for stat in status %}
                            <option value="{{ stat.id }}" {% if data.status_id == stat.id %}selected{% endif %}>{{ stat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group  col-md-2">
                    <label for="pic">PIC:</label>
                    <select multiple class="form-control" id="pic" name="pic">
                        {% for pic in pic_electrical %}
                            <option value="{{ pic.id }}" {% if pic in data.pic.all %}selected{% endif %}>{{ pic.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Masalah, Penyebab, Tindakan, Gambar -->
            <div class="form-row mt-3">
                <div class="form-group" style="width: 100%;">
                    <label for="masalah">Masalah:</label>
                    <textarea class="form-control" id="masalah" name="masalah" rows="3" required>{{ data.masalah }}</textarea>
                </div>
                <div class="form-group" style="width: 100%;">
                    <label for="penyebab">Penyebab:</label>
                    <textarea class="form-control" id="penyebab" name="penyebab" rows="3" required>{{ data.penyebab }}</textarea>
                </div>
                <div class="form-group" style="width: 100%;">
                    <label for="tindakan">Tindakan:</label>
                    <textarea class="form-control" id="tindakan" name="tindakan" rows="3" required>{{ data.tindakan }}</textarea>
                </div>
                <div class="form-group" style="width: 100%;">
                    <label for="image">Add Image:</label>
                    <input type="file" class="form-control-file" id="image" name="image">
                </div>
            </div>       
            <button type="submit" class="btn btn-primary mt-3">Update</button>
        </form>
    </div>
</div>


</div>
{% endblock content %}

{% block scriptcontent %}
<!-- Plugins JS start-->
<script src="{% static 'assets/js/prism/prism.min.js' %}"></script>
<script src="{% static 'assets/js/clipboard/clipboard.min.js' %}"></script>
<script src="{% static 'assets/js/custom-card/custom-card.js' %}"></script>
<script src="{% static 'assets/js/select2/select2.full.min.js' %}"></script>
<script src="{% static 'assets/js/select2/select2-custom.js' %}"></script>
<script src="{% static 'assets/js/custom/location-machine-filter.js' %}"></script>
<script> 
    $(document).ready(function() {
        // Inisialisasi Select2 untuk dropdowns
        $('.select2').select2({
            width: '100%' // Menyesuaikan lebar agar sesuai dengan kontrol form
        });
  
        // Kosongkan dropdown saat diklik
        $('.select2').on('click', function() {
            $(this).val(null).trigger('change'); // Hapus pilihan saat ini
            $('#machine_number').text('-- Pilih Mesin Terlebih Dahulu --'); // Hapus tampilan nomor mesin
        });
  
        // Event ketika lokasi diubah
        $('#location').on('change', function() {
            const locationId = $(this).val();
            console.log('Location ID selected:', locationId);
  
            const machineSelect = $('#machine');
            machineSelect.empty().append('<option value="">-- Pilih Mesin --</option>');
            $('#machine_number').text('-- Pilih Mesin Terlebih Dahulu --'); // Reset tampilan nomor mesin
  
            if (locationId) {
                $.ajax({
                    url: `/dailyactivity/get_machines_by_location_electrical/${locationId}/`,
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log('Data fetched successfully:', data);
                        if (Array.isArray(data) && data.length > 0) {
                            $.each(data, function(index, machine) {
                                // Tambahkan opsi dengan nama dan nomor mesin
                                machineSelect.append(new Option(`${machine.name}  ${machine.nomor}`, machine.id));
                            });
                        } else {
                            console.warn('Tidak ada mesin yang ditemukan untuk lokasi ini.');
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Gagal mengambil data mesin:', textStatus, errorThrown);
                    }
                });
            }
        });
  
        // Event ketika mesin dipilih
        $('#machine').on('change', function() {
            const machineId = $(this).val();
            console.log('Machine ID selected:', machineId);
  
            if (machineId) {
                $.ajax({
                    url: `/dailyactivity/get_machine_number_electrical/${machineId}/`,  // URL untuk mengambil nomor mesin
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log('Nomor mesin berhasil diambil:', data);
                        if (data && data.nomor) {
                            $('#machine_number').text(data.nomor); // Tampilkan nomor mesin
                        } else {
                            $('#machine_number').text('Nomor mesin tidak tersedia');
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Gagal mengambil nomor mesin:', textStatus, errorThrown);
                        $('#machine_number').text('Gagal mengambil nomor');
                    }
                });
            } else {
                $('#machine_number').text('-- Pilih Mesin Terlebih Dahulu --');
            }
        });
    });
  </script>
  
  <script>
    $(document).ready(function() {
      // Initialize Select2 for dropdowns
      $('.select2').select2({
        width: '100%' // Adjust width to match form control
      });
  
      // Clear dropdown on click
      $('.select2').on('click', function() {
        $(this).val(null).trigger('change'); // Clear current selection
      });
    });
  </script>
{% endblock scriptcontent %}
